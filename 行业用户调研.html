<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>营销分析工具（优化版）</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Microsoft YaHei', '微软雅黑', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f9f9f9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            color: #4a6cf7;
            margin-bottom: 10px;
        }

        .description {
            color: #666;
            max-width: 700px;
            margin: 0 auto 20px;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 12px 15px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9rem;
            color: #666;
            position: relative;
            transition: color 0.3s;
        }

        .tab.active {
            color: #4a6cf7;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #4a6cf7;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .analysis-container {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .editor {
            width: 100%;
            height: 500px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            margin-bottom: 20px;
            font-family: 'Microsoft YaHei', '微软雅黑', sans-serif;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .button {
            background-color: #4a6cf7;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .button:hover {
            opacity: 0.9;
        }

        .button.secondary {
            background-color: #eef2ff;
            color: #4a6cf7;
        }

        .button.secondary:hover {
            background-color: #dce4ff;
        }

        #canvas-container {
            display: none;
        }

        canvas {
            max-width: 100%;
            border: 1px solid #ddd;
        }

        .preview-area {
            margin-top: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        .preview-area img {
            max-width: 300px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .page-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        .progress-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 16px;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
                display: flex;
                flex-wrap: nowrap;
            }
            .editor {
                height: 350px;
            }
            .button-group {
                flex-direction: column;
            }
        }

        .logo {
            font-weight: bold;
            color: #4a6cf7;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .logo svg {
            width: 24px;
            height: 24px;
        }
        
        .explanation {
            margin-bottom: 20px; 
            padding: 10px; 
            background-color: #f5f5f5; 
            border-radius: 5px;
            color: #555;
            line-height: 1.5;
        }

        .settings-panel {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }

        .settings-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .settings-group {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .settings-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .settings-item label {
            font-size: 14px;
            color: #555;
        }

        .settings-item select, 
        .settings-item input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                全行业调研助手
            </div>
            <h1>内容分析与导出工具</h1>
            <p class="description">将AI输出的分析内容整理并导出为精美图片，帮助你更好地理解用户需求、挖掘高付费人群、提炼卖点和创建引流内容。</p>
            <button id="export-all-long-image" class="button" style="margin: 10px auto; display: block; background-color: #8c44f7;">导出全部内容为长图</button>
        </header>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" data-tab="user-needs">用户需求分析</button>
                <button class="tab" data-tab="high-pay">高付费人群</button>
                <button class="tab" data-tab="selling-points">卖点分析</button>
                <button class="tab" data-tab="user-thoughts">用户心理分析</button>
            </div>

            <!-- 用户需求分析 -->
            <div class="tab-content active" id="user-needs">
                <div class="analysis-container">
                    <h2>用户需求分析</h2>
                    <div class="explanation">
                        这个工具是帮咱们找准用户真正想要啥的。就像买菜，得知道啥季节人们爱吃啥菜，才能备好货不被退。只有弄清楚用户心里的痒点在哪，咱们才能对症下药，少走弯路，做出真正有人愿意掏钱的产品和服务。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="user-needs-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="user-needs-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <input type="checkbox" id="user-needs-clean-symbols" checked>
                                <label for="user-needs-clean-symbols">去除*和-等符号</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="user-needs-editor" placeholder="粘贴AI生成的用户需求分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('user-needs')">导出为3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('user-needs')">导出为长图</button>
                        <button class="button secondary" onclick="clearEditor('user-needs')">清空内容</button>
                    </div>
                    <div class="preview-area" id="user-needs-preview">
                        <h3>预览</h3>
                        <img id="user-needs-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 高付费人群 -->
            <div class="tab-content" id="high-pay">
                <div class="analysis-container">
                    <h2>高付费人群分析</h2>
                    <div class="explanation">
                        这是找出能交更多钱、不差钱的人群。就像卖水果，有人就爱买精品礼盒装的，不在乎多花点钱。了解这些人为啥掏钱痛快，啥时候最乐意花钱，咱们就能针对性地提供服务，赚得更多，还省了不少力气。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="high-pay-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="high-pay-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <input type="checkbox" id="high-pay-clean-symbols" checked>
                                <label for="high-pay-clean-symbols">去除*和-等符号</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="high-pay-editor" placeholder="粘贴AI生成的高付费人群分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('high-pay')">导出为3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('high-pay')">导出为长图</button>
                        <button class="button secondary" onclick="clearEditor('high-pay')">清空内容</button>
                    </div>
                    <div class="preview-area" id="high-pay-preview">
                        <h3>预览</h3>
                        <img id="high-pay-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 高意向搜索词 -->
            <div class="tab-content" id="search-intent">
                <div class="analysis-container">
                    <h2>高意向搜索需求</h2>
                    <div class="explanation">
                        这是找出用户真正要下单时会搜的关键词。就像有人搜"今天能到的感冒药"和"感冒原因"，明显前者更急着买药。抓住这些词能帮咱们找到那些已经掏出钱包、就等着下单的人，省去大量白忙活，提高成交率。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="search-intent-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="search-intent-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <input type="checkbox" id="search-intent-clean-symbols" checked>
                                <label for="search-intent-clean-symbols">去除*和-等符号</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="search-intent-editor" placeholder="粘贴AI生成的高意向搜索词分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('search-intent')">导出为3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('search-intent')">导出为长图</button>
                        <button class="button secondary" onclick="clearEditor('search-intent')">清空内容</button>
                    </div>
                    <div class="preview-area" id="search-intent-preview">
                        <h3>预览</h3>
                        <img id="search-intent-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 前置需求分析 -->
            <div class="tab-content" id="pre-needs">
                <div class="analysis-container">
                    <h2>前置需求分析</h2>
                    <div class="explanation">
                        这是找出用户产生购买行为前会有的一系列想法和行动。比如买房前，人们会先看学区、算首付、研究贷款政策等。了解这些环节，咱们就能提前布局，在竞争对手还没进场时就抢先接触客户，增加成交几率。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="pre-needs-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="pre-needs-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <input type="checkbox" id="pre-needs-clean-symbols" checked>
                                <label for="pre-needs-clean-symbols">去除*和-等符号</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="pre-needs-editor" placeholder="粘贴AI生成的前置需求分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('pre-needs')">导出为3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('pre-needs')">导出为长图</button>
                        <button class="button secondary" onclick="clearEditor('pre-needs')">清空内容</button>
                    </div>
                    <div class="preview-area" id="pre-needs-preview">
                        <h3>预览</h3>
                        <img id="pre-needs-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 卖点分析 -->
            <div class="tab-content" id="selling-points">
                <div class="analysis-container">
                    <h2>卖点分析</h2>
                    <div class="explanation">
                        这是找出产品最能打动人的亮点。就像卖西瓜，是"特甜"还是"特解渴"还是"无籽方便吃"更能吸引人？好的卖点能一句话就击中痛点、解决犹豫，让用户立刻掏钱，不再货比三家。这能大大提高转化率和复购率。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="selling-points-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="selling-points-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <input type="checkbox" id="selling-points-clean-symbols" checked>
                                <label for="selling-points-clean-symbols">去除*和-等符号</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="selling-points-editor" placeholder="粘贴AI生成的卖点分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('selling-points')">导出为3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('selling-points')">导出为长图</button>
                        <button class="button secondary" onclick="clearEditor('selling-points')">清空内容</button>
                    </div>
                    <div class="preview-area" id="selling-points-preview">
                        <h3>预览</h3>
                        <img id="selling-points-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 用户心理分析 -->
            <div class="tab-content" id="user-thoughts">
                <div class="analysis-container">
                    <h2>用户心理分析</h2>
                    <div class="explanation">
                        这是揭秘用户脑子里在想啥、担心啥、最在乎啥。好比相亲，了解对方喜好和顾虑才能投其所好。知道用户购买时的心理活动，咱们就能打消他们的疑虑、强化他们的期待，设计更有共鸣的营销内容，事半功倍。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="user-thoughts-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="user-thoughts-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <input type="checkbox" id="user-thoughts-clean-symbols" checked>
                                <label for="user-thoughts-clean-symbols">去除*和-等符号</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="user-thoughts-editor" placeholder="粘贴AI生成的用户心理分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('user-thoughts')">导出为3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('user-thoughts')">导出为长图</button>
                        <button class="button secondary" onclick="clearEditor('user-thoughts')">清空内容</button>
                    </div>
                    <div class="preview-area" id="user-thoughts-preview">
                        <h3>预览</h3>
                        <img id="user-thoughts-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 引流笔记思路 -->
            <div class="tab-content" id="content-ideas">
                <div class="analysis-container">
                    <h2>引流笔记思路</h2>
                    <div class="explanation">
                        这是设计能吸引目标用户、让他们主动来找你的内容创意。就像钓鱼，得用对鱼饵才能钓到想要的鱼。好的引流内容能激发用户的好奇心和分享欲，吸引他们主动私信咨询，顺利引导到私域继续深入沟通，提高转化率。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="content-ideas-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="content-ideas-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <input type="checkbox" id="content-ideas-clean-symbols" checked>
                                <label for="content-ideas-clean-symbols">去除*和-等符号</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="content-ideas-editor" placeholder="粘贴AI生成的引流笔记思路内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('content-ideas')">导出为3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('content-ideas')">导出为长图</button>
                        <button class="button secondary" onclick="clearEditor('content-ideas')">清空内容</button>
                    </div>
                    <div class="preview-area" id="content-ideas-preview">
                        <h3>预览</h3>
                        <img id="content-ideas-image" alt="预览图">
                    </div>
                </div>
            </div>

            <!-- 项目分析 -->
            <div class="tab-content" id="project-analysis">
                <div class="analysis-container">
                    <h2>项目分析介绍</h2>
                    <div class="explanation">
                        这是对项目进行全面体检，看看它值不值得投入时间精力和金钱。就像创业前先考察市场，免得热情劲过后发现是个无底洞。好的项目分析能帮咱们看清项目的真实前景和风险，避免盲目跟风和投资亏损，做出更靠谱的决策。
                    </div>
                    <div class="settings-panel">
                        <h3>图像设置</h3>
                        <div class="settings-group">
                            <div class="settings-item">
                                <label for="font-size">字体大小:</label>
                                <select id="project-analysis-font-size">
                                    <option value="20">小</option>
                                    <option value="22" selected>中</option>
                                    <option value="24">大</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <label for="line-height">行高:</label>
                                <select id="project-analysis-line-height">
                                    <option value="30">紧凑</option>
                                    <option value="34" selected>标准</option>
                                    <option value="38">宽松</option>
                                </select>
                            </div>
                            <div class="settings-item">
                                <input type="checkbox" id="project-analysis-clean-symbols" checked>
                                <label for="project-analysis-clean-symbols">去除*和-等符号</label>
                            </div>
                        </div>
                    </div>
                    <textarea class="editor" id="project-analysis-editor" placeholder="粘贴AI生成的项目分析内容..."></textarea>
                    <div class="button-group">
                        <button class="button" onclick="generateImage('project-analysis')">导出为3:4短图</button>
                        <button class="button secondary" onclick="generateLongImage('project-analysis')">导出为长图</button>
                        <button class="button secondary" onclick="clearEditor('project-analysis')">清空内容</button>
                    </div>
                    <div class="preview-area" id="project-analysis-preview">
                        <h3>预览</h3>
                        <img id="project-analysis-image" alt="预览图">
                    </div>
                </div>
            </div>
        </div>

        <!-- 低竞争用户人群 -->
        <div class="tab-content" id="low-competition">
            <div class="analysis-container">
                <h2>低竞争用户人群分析</h2>
                <div class="explanation">
                    想象一下渔民出海捕鱼的场景。大多数渔船都挤在同一片海域，因为那里曾经发现过大量的鱼群。渔船越多，每条船能捕到的鱼就越少，还得花更多的油钱和时间。但总有几个聪明的老渔民，他们会悄悄驶向人少的海域，虽然那里的鱼群体型可能小一些，却因为竞争少而能满载而归，成本却低得多。这就是商业中的"蓝海思维"。
                </div>
                <div class="settings-panel">
                    <h3>图像设置</h3>
                    <div class="settings-group">
                        <div class="settings-item">
                            <label for="font-size">字体大小:</label>
                            <select id="low-competition-font-size">
                                <option value="20">小</option>
                                <option value="22" selected>中</option>
                                <option value="24">大</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <label for="line-height">行高:</label>
                            <select id="low-competition-line-height">
                                <option value="30">紧凑</option>
                                <option value="34" selected>标准</option>
                                <option value="38">宽松</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <input type="checkbox" id="low-competition-clean-symbols" checked>
                            <label for="low-competition-clean-symbols">去除*和-等符号</label>
                        </div>
                    </div>
                </div>
                <textarea class="editor" id="low-competition-editor" placeholder="粘贴AI生成的低竞争用户人群分析内容..."></textarea>
                <div class="button-group">
                    <button class="button" onclick="generateImage('low-competition')">导出为3:4短图</button>
                    <button class="button secondary" onclick="generateLongImage('low-competition')">导出为长图</button>
                    <button class="button secondary" onclick="clearEditor('low-competition')">清空内容</button>
                </div>
                <div class="preview-area" id="low-competition-preview">
                    <h3>预览</h3>
                    <img id="low-competition-image" alt="预览图">
                </div>
            </div>

        <div id="canvas-container">
            <canvas id="image-canvas"></canvas>
        </div>
        
        <div class="progress-indicator" id="progress-indicator">
            正在生成图片，请稍候...
        </div>
    </div>

    <script>
        // 颜色映射
        const colorMap = {
            'user-needs': '#4a6cf7',    // 蓝色
            'high-pay': '#8c44f7',      // 紫色
            'selling-points': '#f39c12', // 橙色
            'user-thoughts': '#3498db'   // 天蓝色
        };
        
        // 标题映射
        const titleMap = {
            'user-needs': '用户需求分析',
            'high-pay': '高付费人群分析',
            'selling-points': '卖点分析',
            'user-thoughts': '用户心理分析'
        };
        
        // 解释映射 - 更通俗的版本
        const explanationMap = {
            'user-needs': '这个工具是帮咱们找准用户真正想要啥的。就像买菜，得知道啥季节人们爱吃啥菜，才能备好货不被退。只有弄清楚用户心里的痒点在哪，咱们才能对症下药，少走弯路，做出真正有人愿意掏钱的产品和服务。',
            'high-pay': '这是找出能交更多钱、不差钱的人群。就像卖水果，有人就爱买精品礼盒装的，不在乎多花点钱。了解这些人为啥掏钱痛快，啥时候最乐意花钱，咱们就能针对性地提供服务，赚得更多，还省了不少力气。',
            'selling-points': '这是找出产品最能打动人的亮点。就像卖西瓜，是"特甜"还是"特解渴"还是"无籽方便吃"更能吸引人？好的卖点能一句话就击中痛点、解决犹豫，让用户立刻掏钱，不再货比三家。这能大大提高转化率和复购率。',
            'user-thoughts': '这是揭秘用户脑子里在想啥、担心啥、最在乎啥。好比相亲，了解对方喜好和顾虑才能投其所好。知道用户购买时的心理活动，咱们就能打消他们的疑虑、强化他们的期待，设计更有共鸣的营销内容，事半功倍。'
        };
        
        // 获取颜色
        function getColorForTab(tabId) {
            return colorMap[tabId] || '#4a6cf7';
        }
        
        // 获取标题
        function getTitle(tabId) {
            return titleMap[tabId] || '分析报告';
        }
        
        // 获取解释
        function getExplanation(tabId) {
            return explanationMap[tabId] || '';
        }
        
        // 获取用户设置的字体大小
        function getFontSize(tabId) {
            const fontSizeSelect = document.getElementById(`${tabId}-font-size`);
            return parseInt(fontSizeSelect.value);
        }
        
        // 获取用户设置的行高
        function getLineHeight(tabId) {
            const lineHeightSelect = document.getElementById(`${tabId}-line-height`);
            return parseInt(lineHeightSelect.value);
        }
        
        // 检查是否应该清理符号
        function shouldCleanSymbols(tabId) {
            const cleanSymbolsCheckbox = document.getElementById(`${tabId}-clean-symbols`);
            return cleanSymbolsCheckbox && cleanSymbolsCheckbox.checked;
        }
        
        // 转换颜色为RGB
        function hexToRgb(hex) {
            hex = hex.replace(/^#/, '');
            
            let r = 0, g = 0, b = 0;
            if (hex.length === 3) {
                r = parseInt(hex[0] + hex[0], 16);
                g = parseInt(hex[1] + hex[1], 16);
                b = parseInt(hex[2] + hex[2], 16);
            } else if (hex.length === 6) {
                r = parseInt(hex.substring(0, 2), 16);
                g = parseInt(hex.substring(2, 4), 16);
                b = parseInt(hex.substring(4, 6), 16);
            }
            
            return [r, g, b];
        }
        
        // 清理文本中的特殊符号
        function cleanTextSymbols(text) {
            if (!text) return text;
            
            // 清理前缀和markdown标记
            let cleanedText = text.replace(/##/g, ''); // 去除所有##标记
            cleanedText = cleanedText.replace(/\n#+\s*/g, '\n'); // 去除可能的markdown标题标记
            cleanedText = cleanedText.replace(/\*/g, ''); // 去除所有*标记，不只是成对的**
            // 清理各种列表标记和破折号
            cleanedText = cleanedText.replace(/^- /gm, '');
            cleanedText = cleanedText.replace(/^– /gm, '');
            cleanedText = cleanedText.replace(/^— /gm, '');
            cleanedText = cleanedText.replace(/^-/gm, '');
            cleanedText = cleanedText.replace(/^–/gm, '');
            cleanedText = cleanedText.replace(/^—/gm, '');
            
            return cleanedText;
        }
        
        // 处理符号清除复选框的变化
        function handleCleanSymbolChange(tabId) {
            const editor = document.getElementById(`${tabId}-editor`);
            const cleanSymbolsCheckbox = document.getElementById(`${tabId}-clean-symbols`);
            
            if (cleanSymbolsCheckbox.checked) {
                // 如果勾选了"去除符号"选项，立即处理文本
                editor.value = cleanTextSymbols(editor.value);
            } 
            // 如果取消勾选，我们不能自动恢复原始格式，因为信息已丢失
            
            // 保存到本地存储
            localStorage.setItem(`marketingTool-${tabId}`, editor.value);
        }

        // 初始化标签切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // 清空编辑器内容
        function clearEditor(tabId) {
            const editor = document.getElementById(`${tabId}-editor`);
            editor.value = '';
            document.getElementById(`${tabId}-preview`).style.display = 'none';
            localStorage.removeItem(`marketingTool-${tabId}`);
        }

        // 文本换行函数
        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            let lines = [];
            let currentLine = '';
            
            // 处理中文和英文混合内容
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const testWidth = context.measureText(currentLine + char).width;
                
                if (testWidth > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = char;
                } else {
                    currentLine += char;
                }
            }
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            // 绘制每一行
            let newY = y;
            for (let i = 0; i < lines.length; i++) {
                context.fillText(lines[i], x, newY);
                newY += lineHeight;
            }
            
            return newY;
        }

        // 下载图片
        function downloadImage(dataUrl, filename) {
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.click();
        }
        
        // 生成图片
        function generateImage(tabId) {
            try {
                const editor = document.getElementById(`${tabId}-editor`);
                const text = editor.value.trim();
                
                if (!text) {
                    alert('请先输入或粘贴内容');
                    return;
                }
                
                // 清理前缀和markdown标记
                let cleanedText = text.replace(/^好的[，,].*?[。\n]/, '');
                cleanedText = cleanedText.replace(/^我来分析.*?[。\n]/, '');
                
                // 因为文本框中的内容可能已经被清理过符号，这里只应用未处理过的清理
                cleanedText = cleanedText.replace(/##/g, ''); // 去除所有##标记
                cleanedText = cleanedText.replace(/\n#+\s*/g, '\n'); // 去除可能的markdown标题标记
                
                // 根据用户设置决定是否清理特殊符号（如果尚未清理）
                if (shouldCleanSymbols(tabId)) {
                    cleanedText = cleanTextSymbols(cleanedText);
                }
                cleanedText = cleanedText.replace(/\*\*/g, ''); // 去除所有**标记
                cleanedText = cleanedText.replace(/^- /gm, ''); // 去除每行开头的- 列表标记
                cleanedText = cleanedText.replace(/^–\s+/gm, ''); // 去除每行开头的–列表标记
                cleanedText = cleanedText.replace(/^—\s+/gm, ''); // 去除每行开头的—列表标记
                
                // 创建画布
                const canvas = document.getElementById('image-canvas');
                const width = 900;
                const height = 1200;
                canvas.width = width;
                canvas.height = height;
                
                const ctx = canvas.getContext('2d');
                
                // 获取用户设置
                const fontSize = getFontSize(tabId);
                const lineHeight = getLineHeight(tabId);
                
                // 准备分页
                const paragraphs = cleanedText.split('\n');
                const pages = [];
                let currentPage = [];
                let estimatedHeight = 0;
                const lineHeightEstimate = lineHeight;
                
                // 获取解释文本
                const explanation = getExplanation(tabId);
                
                // 估计分页，确保每一页都有解释文本
                let explanationHeight = 0;
                if (explanation) {
                    const explanationLines = Math.ceil(explanation.length * (fontSize-2) / (width - 120));
                    explanationHeight = explanationLines * (lineHeight-6) + 30; // 增加一些padding
                }
                
                // 处理正文内容和分页
                for (let i = 0; i < paragraphs.length; i++) {
                    const para = paragraphs[i].trim();
                    if (para === '') {
                        currentPage.push('');
                        estimatedHeight += lineHeightEstimate * 0.5;
                        continue;
                    }
                    
                    // 估算段落高度
                    let paraHeight;
                    if (/^\d+[\.\、]/.test(para)) {
                        // 数字标题
                        const lines = Math.ceil(para.length * fontSize / (width - 100));
                        paraHeight = lines * lineHeightEstimate * 1.5;
                    } else if (para.includes('：') && para.indexOf('：') < 30) {
                        // 冒号标题
                        const lines = Math.ceil(para.length * fontSize / (width - 100));
                        paraHeight = lines * lineHeightEstimate * 1.2;
                    } else {
                        // 普通段落
                        const lines = Math.ceil(para.length * fontSize / (width - 100));
                        paraHeight = lines * lineHeightEstimate;
                    }
                    
                    // 考虑解释文本的高度，确保每页都有足够空间
                    const maxPageHeight = height * 0.75 - explanationHeight - 50;
                    
                    // 检查是否需要新页
                    if (estimatedHeight + paraHeight > maxPageHeight && currentPage.length > 0) {
                        // 将解释文本作为特殊标记添加到每一页
                        currentPage.unshift("#EXPLANATION#" + explanation);
                        
                        pages.push(currentPage);
                        currentPage = [para];
                        estimatedHeight = paraHeight;
                    } else {
                        currentPage.push(para);
                        estimatedHeight += paraHeight;
                    }
                }
                
                if (currentPage.length > 0) {
                    // 确保最后一页也有解释文本
                    currentPage.unshift("#EXPLANATION#" + explanation);
                    pages.push(currentPage);
                }
                
                if (pages.length === 0) {
                    pages.push(["#EXPLANATION#" + explanation, ...paragraphs]);
                }
                
                console.log(`内容将分为 ${pages.length} 页`);
                
                // 创建ZIP（如果有多页）
                let zip = null;
                if (pages.length > 1) {
                    zip = new JSZip();
                }
                
                // 处理每页
                let pageIndex = 0;
                processNextPage();
                
                function processNextPage() {
                    if (pageIndex >= pages.length) {
                        // 完成所有页面
                        if (zip) {
                            zip.generateAsync({type: "blob"}).then(function(content) {
                                const url = URL.createObjectURL(content);
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = `${getTitle(tabId)}.zip`;
                                link.click();
                            });
                        }
                        return;
                    }
                    
                    // 获取当前页内容
                    const pageContent = pages[pageIndex];
                    const pageNum = pageIndex + 1;
                    
                    // 填充白色背景
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, width, height);
                    
                    // 获取主题色
                    const themeColor = getColorForTab(tabId);
                    
                    // 顶部渐变 - 略微增加高度以容纳解释文本
                    const gradient = ctx.createLinearGradient(0, 0, 0, height * 0.2);
                    gradient.addColorStop(0, themeColor);  
                    gradient.addColorStop(1, '#ffffff');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, width, height * 0.2);
                    
                    // 标题
                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 40px Arial, "Microsoft YaHei", "微软雅黑"';
                    const title = getTitle(tabId);
                    ctx.fillText(title, 50, 80);
                    
                    // 页码（如果多页）
                    if (pages.length > 1) {
                        ctx.fillStyle = '#ffffff';
                        ctx.font = '24px Arial, "Microsoft YaHei", "微软雅黑"';
                        ctx.fillText(`${pageNum}/${pages.length}`, width - 100, 80);
                    }
                    
                    // 直接在标题下方添加解释文本，无背景
                    if (explanation) {
                        // 不添加背景，直接在渐变区域写文字
                        ctx.fillStyle = '#333333'; // 使用深色以确保在浅色渐变背景上清晰可见
                        ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        wrapText(ctx, explanation, 50, 120, width - 100, lineHeight);
                    }
                    
                    // 渲染内容 - 向上移动以节省空间
                    const maxWidth = width - 100;
                    let y = height * 0.2 + 20;
                    
                    // 解释文本是否已渲染的标志
                    let hasExplanation = false;
                    
                    // 处理页面内容
                    for (const paragraph of pageContent) {
                        // 如果是解释文本，跳过，因为我们已经在标题下方显示了
                        if (paragraph.startsWith("#EXPLANATION#")) {
                            hasExplanation = true;
                            continue;
                        }
                        
                        if (paragraph.trim() === '') {
                            y += lineHeight * 0.5;
                            continue;
                        }
                        
                        // 特殊格式处理
                        // 1. 检查是否为第一段内容，保持正常字体大小，不要变成标题大小
                        if (!hasExplanation && !paragraph.startsWith('用户角度的心声：')) {
                            // 使用普通段落样式
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            
                            y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight);
                            y += lineHeight * 0.3;
                            
                            hasExplanation = true; // 防止其他段落成为大标题
                            continue;
                        }
                        
                        // 2. 数字标题 (如 "1. 标题")
                        if (/^\d+[\.\、]/.test(paragraph.trim())) {
                            ctx.fillStyle = themeColor;
                            ctx.font = `bold ${fontSize+6}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight * 1.2);
                            y += lineHeight * 0.5;
                            
                            // 重置样式
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        } 
                        // 3. 用户角度的心声部分 - 修改为与普通文本一致的格式，但稍微有所区分
                        else if (paragraph.trim().startsWith('用户角度的心声：')) {
                            // 分离冒号前后的部分
                            const colonIndex = paragraph.indexOf('：');
                            const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                            const afterColon = paragraph.substring(colonIndex + 1);
                            
                            // 冒号前的部分使用普通加粗样式
                            ctx.fillStyle = '#333333';
                            ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            ctx.fillText(beforeColon, 50, y);
                            
                            const beforeWidth = ctx.measureText(beforeColon).width;
                            
                            // 冒号后的部分使用普通样式
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            
                            // 如果冒号后内容较长，另起一行
                            if (afterColon.length > 20 || beforeWidth + ctx.measureText(afterColon).width > maxWidth) {
                                y += lineHeight;
                                y = wrapText(ctx, afterColon, 50, y, maxWidth, lineHeight);
                            } else {
                                // 短内容接着冒号后显示
                                ctx.fillText(afterColon, 50 + beforeWidth, y);
                                y += lineHeight;
                            }
                            
                            // 重置样式
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        }
                        // 4. 冒号标题 (如 "为什么会有这个需求：" 或 "针对这样的需求我们应该怎么做：")
                        else if (paragraph.includes('：') && paragraph.indexOf('：') < 30) {
                            // 分离冒号前后的部分
                            const colonIndex = paragraph.indexOf('：');
                            const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                            const afterColon = paragraph.substring(colonIndex + 1);
                            
                            // 冒号前的部分加粗显示
                            ctx.fillStyle = '#333333';
                            ctx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            const beforeWidth = ctx.measureText(beforeColon).width;
                            ctx.fillText(beforeColon, 50, y);
                            
                            // 冒号后的部分使用普通样式
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            
                            // 如果冒号后的内容较长或包含逗号等，另起一行
                            if (afterColon.length > 30 || afterColon.includes('，') || beforeWidth + ctx.measureText(afterColon).width > maxWidth) {
                                y += lineHeight;
                                y = wrapText(ctx, afterColon, 50, y, maxWidth, lineHeight);
                            } else {
                                // 短内容接着冒号后显示
                                ctx.fillText(afterColon, 50 + beforeWidth, y);
                                y += lineHeight;
                            }
                        }
                        // 5. 普通段落
                        else {
                            ctx.fillStyle = '#333333';
                            ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            y = wrapText(ctx, paragraph.trim(), 50, y, maxWidth, lineHeight);
                            y += lineHeight * 0.3;
                        }
                    }
                    
                    // 获取图像数据
                    const imageData = canvas.toDataURL('image/png');
                    
                    // 显示第一页预览
                    if (pageIndex === 0) {
                        const previewArea = document.getElementById(`${tabId}-preview`);
                        previewArea.style.display = 'flex';
                        const previewImage = document.getElementById(`${tabId}-image`);
                        previewImage.src = imageData;
                        
                        // 页数信息
                        if (pages.length > 1) {
                            let pageInfoElem = document.getElementById(`${tabId}-page-info`);
                            if (!pageInfoElem) {
                                pageInfoElem = document.createElement('div');
                                pageInfoElem.id = `${tabId}-page-info`;
                                pageInfoElem.className = 'page-info';
                                previewArea.appendChild(pageInfoElem);
                            }
                            pageInfoElem.textContent = `共 ${pages.length} 页，第 1 页显示在预览中`;
                        }
                    }
                    
                    // 下载逻辑
                    const fileName = getTitle(tabId);
                    
                    // 多页打包
                    if (zip) {
                        // 转为Blob
                        fetch(imageData)
                            .then(res => res.blob())
                            .then(blob => {
                                // 添加到ZIP
                                zip.file(`${fileName}_第${pageNum}页.png`, blob);
                                
                                // 处理下一页
                                pageIndex++;
                                setTimeout(processNextPage, 50);
                            });
                    } else {
                        // 单页直接下载
                        downloadImage(imageData, `${fileName}.png`);
                        pageIndex++;
                    }
                }
            } catch (error) {
                console.error('生成图片时出错:', error);
                alert('生成图片时出错: ' + error.message);
            }
        }
        
        // 生成长图（将所有内容拼接成一张图）
        function generateLongImage(tabId) {
            try {
                const progressIndicator = document.getElementById('progress-indicator');
                progressIndicator.style.display = 'block';
                
                const editor = document.getElementById(`${tabId}-editor`);
                const text = editor.value.trim();
                
                if (!text) {
                    alert('请先输入或粘贴内容');
                    progressIndicator.style.display = 'none';
                    return;
                }
                
                // 清理前缀和markdown标记
                let cleanedText = text.replace(/^好的[，,].*?[。\n]/, '');
                cleanedText = cleanedText.replace(/^我来分析.*?[。\n]/, '');
                cleanedText = cleanedText.replace(/##/g, ''); // 去除所有##标记
                cleanedText = cleanedText.replace(/\n#+\s*/g, '\n'); // 去除可能的markdown标题标记
                
                // 创建临时画布用于测量
                const canvas = document.getElementById('image-canvas');
                const width = 900;
                const ctx = canvas.getContext('2d');
                
                // 获取用户设置
                const fontSize = getFontSize(tabId);
                const lineHeight = getLineHeight(tabId);
                
                // 获取解释文本
                const explanation = getExplanation(tabId);
                const themeColor = getColorForTab(tabId);
                const title = getTitle(tabId);
                
                // 准备段落
                const paragraphs = cleanedText.split('\n');
                
                // 计算标题区域高度
                const headerHeight = 240; // 标题+渐变+解释文本的高度
                
                // 估算总高度
                let totalHeight = headerHeight;
                
                // 设置字体以便测量文本
                ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                
                // 估算段落所需高度
                for (const para of paragraphs) {
                    if (para.trim() === '') {
                        totalHeight += lineHeight * 0.5;
                        continue;
                    }
                    
                    // 根据段落类型估算高度
                    if (/^\d+[\.\、]/.test(para.trim())) {
                        // 数字标题
                        const lines = Math.ceil(ctx.measureText(para.trim()).width / (width - 100));
                        totalHeight += lines * lineHeight * 1.5 + lineHeight * 0.5;
                    } else if (para.includes('：') && para.indexOf('：') < 30) {
                        // 冒号标题
                        const colonIndex = para.indexOf('：');
                        const afterColon = para.substring(colonIndex + 1);
                        
                        if (afterColon.length > 30 || afterColon.includes('，')) {
                            // 冒号后文本较长，另起一行
                            const lines = Math.ceil(ctx.measureText(afterColon).width / (width - 100));
                            totalHeight += lineHeight + lines * lineHeight + lineHeight * 0.5;
                        } else {
                            totalHeight += lineHeight + lineHeight * 0.5;
                        }
                    } else {
                        // 普通段落
                        const lines = Math.ceil(ctx.measureText(para.trim()).width / (width - 100));
                        totalHeight += lines * lineHeight + lineHeight * 0.3;
                    }
                }
                
                // 添加底部边距
                totalHeight += 50;
                
                // 设置画布大小
                canvas.width = width;
                canvas.height = totalHeight;
                
                // 重新获取上下文（因为调整了大小）
                const longCtx = canvas.getContext('2d');
                
                // 填充白色背景
                longCtx.fillStyle = '#ffffff';
                longCtx.fillRect(0, 0, width, totalHeight);
                
                // 绘制顶部渐变
                const gradient = longCtx.createLinearGradient(0, 0, 0, headerHeight);
                gradient.addColorStop(0, themeColor);  
                gradient.addColorStop(0.5, '#ffffff');
                longCtx.fillStyle = gradient;
                longCtx.fillRect(0, 0, width, headerHeight);
                
                // 绘制标题
                longCtx.fillStyle = '#ffffff';
                longCtx.font = 'bold 40px Arial, "Microsoft YaHei", "微软雅黑"';
                longCtx.fillText(title, 50, 80);
                
                // 绘制解释文本
                if (explanation) {
                    longCtx.fillStyle = '#333333';
                    longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                    wrapText(longCtx, explanation, 50, 120, width - 100, lineHeight);
                }
                
                // 开始绘制内容
                let y = headerHeight;
                const maxWidth = width - 100;
                
                // 绘制所有段落
                for (const paragraph of paragraphs) {
                    if (paragraph.trim() === '') {
                        y += lineHeight * 0.5;
                        continue;
                    }
                    
                    // 特殊格式处理
                    // 1. 数字标题 (如 "1. 标题")
                    if (/^\d+[\.\、]/.test(paragraph.trim())) {
                        longCtx.fillStyle = themeColor;
                        longCtx.font = `bold ${fontSize+6}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        y = wrapText(longCtx, paragraph.trim(), 50, y, maxWidth, lineHeight * 1.2);
                        y += lineHeight * 0.5;
                        
                        // 重置样式
                        longCtx.fillStyle = '#333333';
                        longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                    } 
                    // 2. 用户角度的心声部分
                    else if (paragraph.trim().startsWith('用户角度的心声：')) {
                        // 分离冒号前后的部分
                        const colonIndex = paragraph.indexOf('：');
                        const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                        const afterColon = paragraph.substring(colonIndex + 1);
                        
                        // 冒号前的部分使用普通加粗样式
                        longCtx.fillStyle = '#333333';
                        longCtx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        longCtx.fillText(beforeColon, 50, y);
                        
                        const beforeWidth = longCtx.measureText(beforeColon).width;
                        
                        // 冒号后的部分使用普通样式
                        longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        
                        // 如果冒号后内容较长，另起一行
                        if (afterColon.length > 20 || beforeWidth + longCtx.measureText(afterColon).width > maxWidth) {
                            y += lineHeight;
                            y = wrapText(longCtx, afterColon, 50, y, maxWidth, lineHeight);
                        } else {
                            // 短内容接着冒号后显示
                            longCtx.fillText(afterColon, 50 + beforeWidth, y);
                            y += lineHeight;
                        }
                        
                        // 重置样式
                        longCtx.fillStyle = '#333333';
                        longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                    }
                    // 3. 冒号标题
                    else if (paragraph.includes('：') && paragraph.indexOf('：') < 30) {
                        // 分离冒号前后的部分
                        const colonIndex = paragraph.indexOf('：');
                        const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                        const afterColon = paragraph.substring(colonIndex + 1);
                        
                        // 冒号前的部分加粗显示
                        longCtx.fillStyle = '#333333';
                        longCtx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        const beforeWidth = longCtx.measureText(beforeColon).width;
                        longCtx.fillText(beforeColon, 50, y);
                        
                        // 冒号后的部分使用普通样式
                        longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        
                        // 如果冒号后的内容较长或包含逗号等，另起一行
                        if (afterColon.length > 30 || afterColon.includes('，') || beforeWidth + longCtx.measureText(afterColon).width > maxWidth) {
                            y += lineHeight;
                            y = wrapText(longCtx, afterColon, 50, y, maxWidth, lineHeight);
                        } else {
                            // 短内容接着冒号后显示
                            longCtx.fillText(afterColon, 50 + beforeWidth, y);
                            y += lineHeight;
                        }
                    }
                    // 4. 普通段落
                    else {
                        longCtx.fillStyle = '#333333';
                        longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        y = wrapText(longCtx, paragraph.trim(), 50, y, maxWidth, lineHeight);
                        y += lineHeight * 0.3;
                    }
                }
                
                // 获取图像数据
                const imageData = canvas.toDataURL('image/png');
                
                // 显示预览
                const previewArea = document.getElementById(`${tabId}-preview`);
                previewArea.style.display = 'flex';
                const previewImage = document.getElementById(`${tabId}-image`);
                previewImage.src = imageData;
                
                // 显示提示信息
                let pageInfoElem = document.getElementById(`${tabId}-page-info`);
                if (!pageInfoElem) {
                    pageInfoElem = document.createElement('div');
                    pageInfoElem.id = `${tabId}-page-info`;
                    pageInfoElem.className = 'page-info';
                    previewArea.appendChild(pageInfoElem);
                }
                pageInfoElem.textContent = `已生成长图，高度: ${totalHeight}px`;
                
                // 下载图片
                const fileName = `${getTitle(tabId)}_长图`;
                downloadImage(imageData, `${fileName}.png`);
                
                progressIndicator.style.display = 'none';
            } catch (error) {
                console.error('生成长图时出错:', error);
                document.getElementById('progress-indicator').style.display = 'none';
                alert('生成长图时出错: ' + error.message);
            }
        }
        
        // 导出所有内容为长图
        function exportAllAsLongImage() {
            try {
                const progressIndicator = document.getElementById('progress-indicator');
                progressIndicator.style.display = 'block';
                progressIndicator.textContent = '正在生成所有内容的长图...';
                
                // 标签页列表
                const tabs = [
                    'user-needs', 
                    'high-pay', 
                    'search-intent', 
                    'pre-needs', 
                    'selling-points', 
                    'user-thoughts', 
                    'content-ideas', 
                    'project-analysis',
                    'low-competition'
                ];
                
                // 筛选有内容的标签页
                const tabsWithContent = tabs.filter(tabId => {
                    const editor = document.getElementById(`${tabId}-editor`);
                    return editor.value.trim() !== '';
                });
                
                if (tabsWithContent.length === 0) {
                    alert('没有可导出的内容，请先在至少一个标签页中输入内容');
                    progressIndicator.style.display = 'none';
                    return;
                }
                
                // 创建一个zip文件来存储所有长图
                const zip = new JSZip();
                
                // 处理每个有内容的标签页
                let currentIndex = 0;
                
                processNextTab();
                
                function processNextTab() {
                    if (currentIndex >= tabsWithContent.length) {
                        // 所有标签都已处理完，保存ZIP
                        progressIndicator.textContent = '正在打包所有图片...';
                        
                        zip.generateAsync({type: 'blob'}).then(function(content) {
                            // 下载ZIP文件
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(content);
                            link.download = '营销分析图片集.zip';
                            link.click();
                            
                            progressIndicator.style.display = 'none';
                        });
                        
                        return;
                    }
                    
                    const tabId = tabsWithContent[currentIndex];
                    progressIndicator.textContent = `正在处理 ${getTitle(tabId)}...`;
                    
                    const editor = document.getElementById(`${tabId}-editor`);
                    const text = editor.value.trim();
                    
                    // 清理前缀和markdown标记
                    let cleanedText = text.replace(/^好的[，,].*?[。\n]/, '');
                    cleanedText = cleanedText.replace(/^我来分析.*?[。\n]/, '');
                    
                    // 因为文本框中的内容可能已经被清理过符号，这里只应用未处理过的清理
                    cleanedText = cleanedText.replace(/##/g, ''); // 去除所有##标记
                    cleanedText = cleanedText.replace(/\n#+\s*/g, '\n'); // 去除可能的markdown标题标记
                    
                    // 根据用户设置决定是否清理特殊符号（如果尚未清理）
                    if (shouldCleanSymbols(tabId)) {
                        cleanedText = cleanTextSymbols(cleanedText);
                    }
                    cleanedText = cleanedText.replace(/\*/g, ''); // 去除所有*标记，不只是成对的**
                    // 清理各种列表标记和破折号
                    cleanedText = cleanedText.replace(/^- /gm, '');
                    cleanedText = cleanedText.replace(/^– /gm, '');
                    cleanedText = cleanedText.replace(/^— /gm, '');
                    cleanedText = cleanedText.replace(/^-/gm, '');
                    cleanedText = cleanedText.replace(/^–/gm, '');
                    cleanedText = cleanedText.replace(/^—/gm, '');
                    
                    // 创建临时画布
                    const canvas = document.getElementById('image-canvas');
                    const width = 900;
                    const ctx = canvas.getContext('2d');
                    
                    // 获取用户设置
                    const fontSize = getFontSize(tabId);
                    const lineHeight = getLineHeight(tabId);
                    
                    // 获取解释文本
                    const explanation = getExplanation(tabId);
                    const themeColor = getColorForTab(tabId);
                    const title = getTitle(tabId);
                    
                    // 准备段落
                    const paragraphs = cleanedText.split('\n');
                    
                    // 计算标题区域高度
                    const headerHeight = 240; // 标题+渐变+解释文本的高度
                    
                    // 估算总高度
                    let totalHeight = headerHeight;
                    
                    // 设置字体以便测量文本
                    ctx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                    
                    // 估算段落所需高度
                    for (const para of paragraphs) {
                        if (para.trim() === '') {
                            totalHeight += lineHeight * 0.5;
                            continue;
                        }
                        
                        // 根据段落类型估算高度
                        if (/^\d+[\.\、]/.test(para.trim())) {
                            // 数字标题
                            const lines = Math.ceil(ctx.measureText(para.trim()).width / (width - 100));
                            totalHeight += lines * lineHeight * 1.5 + lineHeight * 0.5;
                        } else if (para.includes('：') && para.indexOf('：') < 30) {
                            // 冒号标题
                            const colonIndex = para.indexOf('：');
                            const afterColon = para.substring(colonIndex + 1);
                            
                            if (afterColon.length > 30 || afterColon.includes('，')) {
                                // 冒号后文本较长，另起一行
                                const lines = Math.ceil(ctx.measureText(afterColon).width / (width - 100));
                                totalHeight += lineHeight + lines * lineHeight + lineHeight * 0.5;
                            } else {
                                totalHeight += lineHeight + lineHeight * 0.5;
                            }
                        } else {
                            // 普通段落
                            const lines = Math.ceil(ctx.measureText(para.trim()).width / (width - 100));
                            totalHeight += lines * lineHeight + lineHeight * 0.3;
                        }
                    }
                    
                    // 添加底部边距
                    totalHeight += 50;
                    
                    // 设置画布大小
                    canvas.width = width;
                    canvas.height = totalHeight;
                    
                    // 重新获取上下文（因为调整了大小）
                    const longCtx = canvas.getContext('2d');
                    
                    // 填充白色背景
                    longCtx.fillStyle = '#ffffff';
                    longCtx.fillRect(0, 0, width, totalHeight);
                    
                    // 绘制顶部渐变
                    const gradient = longCtx.createLinearGradient(0, 0, 0, headerHeight);
                    gradient.addColorStop(0, themeColor);  
                    gradient.addColorStop(0.5, '#ffffff');
                    longCtx.fillStyle = gradient;
                    longCtx.fillRect(0, 0, width, headerHeight);
                    
                    // 绘制标题
                    longCtx.fillStyle = '#ffffff';
                    longCtx.font = 'bold 40px Arial, "Microsoft YaHei", "微软雅黑"';
                    longCtx.fillText(title, 50, 80);
                    
                    // 绘制解释文本
                    if (explanation) {
                        longCtx.fillStyle = '#333333';
                        longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        wrapText(longCtx, explanation, 50, 120, width - 100, lineHeight);
                    }
                    
                    // 开始绘制内容
                    let y = headerHeight;
                    const maxWidth = width - 100;
                    
                    // 绘制所有段落
                    for (const paragraph of paragraphs) {
                        if (paragraph.trim() === '') {
                            y += lineHeight * 0.5;
                            continue;
                        }
                        
                        // 特殊格式处理
                        // 1. 数字标题 (如 "1. 标题")
                        if (/^\d+[\.\、]/.test(paragraph.trim())) {
                            longCtx.fillStyle = themeColor;
                            longCtx.font = `bold ${fontSize+6}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            y = wrapText(longCtx, paragraph.trim(), 50, y, maxWidth, lineHeight * 1.2);
                            y += lineHeight * 0.5;
                            
                            // 重置样式
                            longCtx.fillStyle = '#333333';
                            longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        } 
                        // 2. 用户角度的心声部分
                        else if (paragraph.trim().startsWith('用户角度的心声：')) {
                            // 分离冒号前后的部分
                            const colonIndex = paragraph.indexOf('：');
                            const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                            const afterColon = paragraph.substring(colonIndex + 1);
                            
                            // 冒号前的部分使用普通加粗样式
                            longCtx.fillStyle = '#333333';
                            longCtx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            longCtx.fillText(beforeColon, 50, y);
                            
                            const beforeWidth = longCtx.measureText(beforeColon).width;
                            
                            // 冒号后的部分使用普通样式
                            longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            
                            // 如果冒号后内容较长，另起一行
                            if (afterColon.length > 20 || beforeWidth + longCtx.measureText(afterColon).width > maxWidth) {
                                y += lineHeight;
                                y = wrapText(longCtx, afterColon, 50, y, maxWidth, lineHeight);
                            } else {
                                // 短内容接着冒号后显示
                                longCtx.fillText(afterColon, 50 + beforeWidth, y);
                                y += lineHeight;
                            }
                            
                            // 重置样式
                            longCtx.fillStyle = '#333333';
                            longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                        }
                        // 3. 冒号标题
                        else if (paragraph.includes('：') && paragraph.indexOf('：') < 30) {
                            // 分离冒号前后的部分
                            const colonIndex = paragraph.indexOf('：');
                            const beforeColon = paragraph.substring(0, colonIndex + 1); // 包括冒号
                            const afterColon = paragraph.substring(colonIndex + 1);
                            
                            // 冒号前的部分加粗显示
                            longCtx.fillStyle = '#333333';
                            longCtx.font = `bold ${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            const beforeWidth = longCtx.measureText(beforeColon).width;
                            longCtx.fillText(beforeColon, 50, y);
                            
                            // 冒号后的部分使用普通样式
                            longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            
                            // 如果冒号后的内容较长或包含逗号等，另起一行
                            if (afterColon.length > 30 || afterColon.includes('，') || beforeWidth + longCtx.measureText(afterColon).width > maxWidth) {
                                y += lineHeight;
                                y = wrapText(longCtx, afterColon, 50, y, maxWidth, lineHeight);
                            } else {
                                // 短内容接着冒号后显示
                                longCtx.fillText(afterColon, 50 + beforeWidth, y);
                                y += lineHeight;
                            }
                        }
                        // 4. 普通段落
                        else {
                            longCtx.fillStyle = '#333333';
                            longCtx.font = `${fontSize}px Arial, "Microsoft YaHei", "微软雅黑"`;
                            y = wrapText(longCtx, paragraph.trim(), 50, y, maxWidth, lineHeight);
                            y += lineHeight * 0.3;
                        }
                    }
                    
                    // 获取图像数据
                    const imageData = canvas.toDataURL('image/png');
                    
                    // 显示预览（只显示当前选中的标签页）
                    const activeTabId = document.querySelector('.tab.active').getAttribute('data-tab');
                    if (tabId === activeTabId) {
                        const previewArea = document.getElementById(`${tabId}-preview`);
                        previewArea.style.display = 'flex';
                        const previewImage = document.getElementById(`${tabId}-image`);
                        previewImage.src = imageData;
                        
                        // 显示提示信息
                        let pageInfoElem = document.getElementById(`${tabId}-page-info`);
                        if (!pageInfoElem) {
                            pageInfoElem = document.createElement('div');
                            pageInfoElem.id = `${tabId}-page-info`;
                            pageInfoElem.className = 'page-info';
                            previewArea.appendChild(pageInfoElem);
                        }
                        pageInfoElem.textContent = `已生成长图，高度: ${totalHeight}px`;
                    }
                    
                    // 转换为Blob并添加到ZIP
                    fetch(imageData)
                        .then(res => res.blob())
                        .then(blob => {
                            zip.file(`${title}_长图.png`, blob);
                            
                            // 处理下一个标签页
                            currentIndex++;
                            setTimeout(processNextTab, 50);
                        })
                        .catch(error => {
                            console.error('处理图片数据出错:', error);
                            currentIndex++;
                            setTimeout(processNextTab, 50);
                        });
                }
            } catch (error) {
                console.error('导出所有内容为长图时出错:', error);
                document.getElementById('progress-indicator').style.display = 'none';
                alert('导出所有内容为长图时出错: ' + error.message);
            }
        }

        // 初始化本地存储
        function initLocalStorage() {
            const tabs = [
                'user-needs', 
                'high-pay', 
                'selling-points', 
                'user-thoughts'
            ];
            
            tabs.forEach(tab => {
                const editor = document.getElementById(`${tab}-editor`);
                
                // 恢复内容
                const savedContent = localStorage.getItem(`marketingTool-${tab}`);
                if (savedContent) {
                    editor.value = savedContent;
                }
                
                // 保存编辑内容
                editor.addEventListener('input', function() {
                    localStorage.setItem(`marketingTool-${tab}`, this.value);
                });
                
                // 为清理符号复选框添加事件监听器
                const cleanSymbolsCheckbox = document.getElementById(`${tab}-clean-symbols`);
                if (cleanSymbolsCheckbox) {
                    cleanSymbolsCheckbox.addEventListener('change', function() {
                        handleCleanSymbolChange(tab);
                    });
                }
            });
        }
        
        // 初始化
        window.addEventListener('load', function() {
            try {
                initLocalStorage();
                
                // 绑定导出所有标签页为长图按钮
                document.getElementById('export-all-long-image').addEventListener('click', exportAllAsLongImage);
                
                console.log('营销分析工具初始化完成');
            } catch (error) {
                console.error('初始化时出错:', error);
            }
        });
    </script>
</body>
</html>